<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Docker,Spark," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="公司需要一个离线的分析系统，我打算直接在阿里云上开N台按量付费的机子然后一起跑。整个系统打算使用 Docker、Spark 来搞。即在阿里云的机子上先搭一层 Docker ，然后在 Docker 的基础上搭建 Spark 的集群。">
<meta name="keywords" content="Docker,Spark">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker 部署 Spark">
<meta property="og:url" content="https://zjuturtle.com/2017/05/17/docker-spark/index.html">
<meta property="og:site_name" content="zjuturtle&#39;s blog">
<meta property="og:description" content="公司需要一个离线的分析系统，我打算直接在阿里云上开N台按量付费的机子然后一起跑。整个系统打算使用 Docker、Spark 来搞。即在阿里云的机子上先搭一层 Docker ，然后在 Docker 的基础上搭建 Spark 的集群。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-09-22T03:37:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Docker 部署 Spark">
<meta name="twitter:description" content="公司需要一个离线的分析系统，我打算直接在阿里云上开N台按量付费的机子然后一起跑。整个系统打算使用 Docker、Spark 来搞。即在阿里云的机子上先搭一层 Docker ，然后在 Docker 的基础上搭建 Spark 的集群。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zjuturtle.com/2017/05/17/docker-spark/"/>





  <title>Docker 部署 Spark | zjuturtle's blog</title>
  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=61683784";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zjuturtle's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zjuturtle.com/2017/05/17/docker-spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zjuturtle">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zjuturtle's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Docker 部署 Spark</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-17T16:22:09+08:00">
                2017-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TechChatter/" itemprop="url" rel="index">
                    <span itemprop="name">TechChatter</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/05/17/docker-spark/" class="leancloud_visitors" data-flag-title="Docker 部署 Spark">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>公司需要一个离线的分析系统，我打算直接在阿里云上开N台按量付费的机子然后一起跑。整个系统打算使用 Docker、Spark 来搞。即在阿里云的机子上先搭一层 Docker ，然后在 Docker 的基础上搭建 Spark 的集群。</p>
<a id="more"></a>
<h2 id="docker">Docker</h2>
<p>讲真 Docker 是好东西，拿来批量部署简直爽。</p>
<p>由于众所周知的原因，从国外网站拖东西是很慢的，需要一些梯子。Docker for Mac自带一个代理设置，不过这个代理简直了。我的 Surge 的 HTTP 代理默认挂在127.0.0.1上面，但是Docker总是搞不清楚127.0.0.1指的是自己还是指的本机。瞎几把折腾了一段时间姑且有了一个临时的解决方案。</p>
<p>参考<a href="https://docs.docker.com/docker-for-mac/networking/#there-is-no-docker0-bridge-on-macos" target="_blank" rel="external">文档</a>，Docker for mac 的实现有些不太一样，它的 host 其实是在 mac 上的一个虚拟机，而不是 mac 本身。理论上只要让 Docker 能分清楚自己（作为虚拟机的 host ）和本机的区别就可以，因此我做了以下操作：</p>
<ul>
<li>将 Surge 的<code>HTTP_PROXY</code>设成一个不用的IP地址（比如10.200.10.1:6152），可能需要重启Surge</li>
<li>sudo ifconfig lo0 alias 10.200.10.1</li>
<li>将 Docker 的代理设置为10.200.10.1:6152</li>
</ul>
<p>这样 Docker 就会走10.200.10.1的代理，然后10.200.10.1是本机的别名，同时 Surge 的代理也是如此，因此解决了127.0.0.1的重名问题</p>
<p>唯一的遗留问题是如果真的有某个倒霉的设备IP地址是10.200.10.1。恩…这种事情一定不会发生的，对吧？</p>
<h2 id="spark">Spark</h2>
<p>我打算以一个 Ubuntu 的 images 为基础，在上面搭上环境，再 docker save 出来，不知道有没有更好的方法，不过先这么着吧。</p>
<p>其实 Docker 提供的 Ubuntu 镜像很小，也就意味着它毛都没有。因此需要自己动手装 python、gcc、make、vim 之类的软件（谢天谢地 apt 它还是有的）。</p>
<p>整一个 Dockerfile 如下，注意包里直接包含了 jdk 和 spark</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:16.04</div><div class="line">WORKDIR /app</div><div class="line">ADD . /app</div><div class="line">RUN mkdir local</div><div class="line">RUN tar -zxf jdk-8u131-linux-x64.tar.gz &amp;&amp; rm jdk-8u131-linux-x64.tar.gz &amp;&amp; mv jdk1.8.0_131 local/jdk</div><div class="line">RUN tar -zxf spark-2.1.0-bin-hadoop2.7.tgz &amp;&amp; rm spark-2.1.0-bin-hadoop2.7.tgz &amp;&amp; mv spark-2.1.0-bin-hadoop2.7 local/spark</div><div class="line">RUN unset http_proxy HTTP_PROXY https_proxy HTTPS_PROXY</div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y \</div><div class="line">        python3 \</div><div class="line">        gcc \</div><div class="line">        make \</div><div class="line">        vim</div><div class="line">ENV JAVA_HOME=/app/local/jdk</div><div class="line">ENV PATH $JAVA_HOME/bin:$PATH</div><div class="line">ENV PYSPARK_PYTHON=python3</div></pre></td></tr></table></figure>
<p>Spark 的 Master 启动脚本<code>start-master.sh</code>如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment"># start-master.sh</span></div><div class="line"></div><div class="line"><span class="comment"># start spark master</span></div><div class="line">/app/<span class="built_in">local</span>/spark/sbin/start-master.sh&gt;/dev/null</div><div class="line"></div><div class="line"><span class="comment"># show log file</span></div><div class="line">logFileList=($(find /app/<span class="built_in">local</span>/spark/logs -name <span class="string">"*.out"</span>))</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#logFileList[*]&#125;</span> -gt 1 ];<span class="keyword">then</span> </div><div class="line">    <span class="built_in">echo</span> <span class="string">'[WARN]logfile is not unique'</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#logFileList[*]&#125;</span> -eq 0 ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'[WARN]logfile not exits'</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line">logFile=<span class="variable">$&#123;logFileList[0]&#125;</span></div><div class="line">tail -f <span class="variable">$&#123;logFile&#125;</span></div></pre></td></tr></table></figure>
<p>Spark 的 Slave 启动脚本<code>start-slave.sh</code>如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment"># start-slave.sh</span></div><div class="line"></div><div class="line"><span class="comment"># start spark master</span></div><div class="line">/app/<span class="built_in">local</span>/spark/sbin/start-slave.sh <span class="variable">$1</span>&gt;/dev/null</div><div class="line"></div><div class="line"><span class="comment"># show log file</span></div><div class="line">logFileList=($(find /app/<span class="built_in">local</span>/spark/logs -name <span class="string">"*.out"</span>))</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#logFileList[*]&#125;</span> -gt 1 ];<span class="keyword">then</span> </div><div class="line">    <span class="built_in">echo</span> <span class="string">'[WARN]logfile is not unique'</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#logFileList[*]&#125;</span> -eq 0 ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'[WARN]logfile not exits'</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line">logFile=<span class="variable">$&#123;logFileList[0]&#125;</span></div><div class="line">tail -f <span class="variable">$&#123;logFile&#125;</span></div></pre></td></tr></table></figure>
<p>启动脚本的最后一行是<code>tail -f ${logFile}</code>，也就是说会把日志丢到 container 的 STDOUT 中。用<code>docker logs [containerID]</code>就可以查看日志啦</p>
<p>在 docker 下的启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 8088:8088 -p 4040:4040 -p 7077:7077 -p 8080:8080 -p 6066:6066 --name=sparkMaster <span class="built_in">local</span>/sparkcluster /app/start-master.sh</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d --name=sparkSlave <span class="built_in">local</span>/sparkcluster /app/start-slave.sh [IP:port]</div></pre></td></tr></table></figure>
<h2 id="docker-网络">Docker 网络</h2>
<p>其实关于 Docker 的 network 部分我捣鼓了好久，也没有什么特别好的解决方案。对于 Docker 而言，一个 container 可以根据 –network 参数指定它的 network 类型。默认情况下网络类型是 bridge，其余还有 host 和 none 两种。参照 Docker 的<a href="https://docs.docker.com/engine/reference/run/#network-settings" target="_blank" rel="external">文档</a>，理想情况下为了提升性能应该使用 host 模式，注意这里的措辞是 significantly.</p>
<blockquote>
<p>Compared to the default bridge mode, the host mode gives significantly better networking performance since it uses the host’s native networking stack whereas the bridge has to go through one level of virtualization through the docker daemon. It is recommended to run containers in this mode when their networking performance is critical, for example, a production Load Balancer or a High Performance Web Server.</p>
</blockquote>
<p>但在我那高贵的 mac 上，指定 <code>network=host</code> 好像是不行的。详细的原因是 Docker for Mac 的 Docker 的 host 其实是在一个 HyperKit 虚拟机上，而不是直接在 mac 上。相当于mac上首先架设了一个虚拟机，再在这个虚拟机上运行了 docker ，也就是说这里指定的 host 其实相当于 HyperKit 虚拟机。关于这个问题，可以参考 github 上的 <a href="https://github.com/docker/for-mac/issues/1031" target="_blank" rel="external">issue1031</a> 和 <a href="https://github.com/docker/for-mac/issues/68" target="_blank" rel="external">issue68</a></p>
<p>不得已，只能使用默认的 bridge 模式。</p>
<h2 id="部署">部署</h2>
<p>在我的本地 Mac 上，通过<code>docker run</code>可以直接跑起来，也能够访问<code>localhost:8080</code>看到 Spark 的控制面板。</p>
<p>讲道理的话，在阿里云的 ECS 集群上部署还是有点麻烦。因为国内网络的问题，Docker Store 是指望不上了。我的想法其实是把整个 export 出来的镜像放到 OSS 上，然后写一个脚本安装部署。</p>
<p>远程部署 python 脚本<code>deploy.py</code>，实际的使用中，填好 <code>config.json</code> 直接在本地跑就可以</p>
<p>设置样例<code>config.example.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"master"</span>:&#123;<span class="attr">"IP"</span>:<span class="string">""</span>,<span class="attr">"password"</span>:<span class="string">""</span>&#125;,</div><div class="line">  <span class="attr">"workers"</span>:[&#123;<span class="attr">"IP"</span>:<span class="string">""</span>,<span class="attr">"password"</span>:<span class="string">""</span>&#125;],</div><div class="line">  <span class="attr">"end_point"</span>:<span class="string">""</span>,</div><div class="line">  <span class="attr">"bucket_name"</span>:<span class="string">""</span>,</div><div class="line">  <span class="attr">"access_key_id"</span>:<span class="string">""</span>,</div><div class="line">  <span class="attr">"access_key_secret"</span>:<span class="string">""</span>,</div><div class="line">  <span class="attr">"oss_docker_image_name"</span>:<span class="string">"sparkCluster.tar"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>docker 部署脚本<code>deploy.py</code> ，注意该部署脚本使用了 threading 模块和 Event 来同时部署多台机器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> paramiko</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line"><span class="comment"># 载入外部设置</span></div><div class="line"><span class="keyword">with</span> open(<span class="string">'config.json'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">    config_data = json.load(f)</div><div class="line">MASTER = config_data[<span class="string">'master'</span>]</div><div class="line">WORKERS = config_data[<span class="string">'workers'</span>]</div><div class="line"><span class="keyword">with</span> open(<span class="string">'config.json.tmp'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> outfile:</div><div class="line">    data = dict()</div><div class="line">    data[<span class="string">'end_point'</span>] = config_data[<span class="string">'end_point'</span>]</div><div class="line">    data[<span class="string">'bucket_name'</span>] = config_data[<span class="string">'bucket_name'</span>]</div><div class="line">    data[<span class="string">'access_key_id'</span>] = config_data[<span class="string">'access_key_id'</span>]</div><div class="line">    data[<span class="string">'access_key_secret'</span>] = config_data[<span class="string">'access_key_secret'</span>]</div><div class="line">    data[<span class="string">'oss_docker_image_name'</span>] = config_data[<span class="string">'oss_docker_image_name'</span>]</div><div class="line">    json.dump(data, outfile)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">docker_spark_start</span><span class="params">(ip, password, name, run_cmd, event=None)</span>:</span></div><div class="line">    <span class="keyword">with</span> open(<span class="string">'docker_install.sh'</span>) <span class="keyword">as</span> fo:</div><div class="line">        docker_install_cmd = fo.read().splitlines()</div><div class="line">    ssh = paramiko.SSHClient()</div><div class="line">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</div><div class="line">    ssh.connect(hostname=ip, port=<span class="number">22</span>, username=<span class="string">'root'</span>, password=password)</div><div class="line">    sftp = ssh.open_sftp()</div><div class="line">    sftp.put(<span class="string">'get_docker_image.py'</span>, <span class="string">'get_docker_image.py'</span>)</div><div class="line"></div><div class="line">    sftp.put(<span class="string">'config.json.tmp'</span>, <span class="string">'config.json'</span>)</div><div class="line">    <span class="keyword">for</span> cmd <span class="keyword">in</span> docker_install_cmd:</div><div class="line">        stdin, stdout, stderr = ssh.exec_command(cmd)</div><div class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> iter(<span class="keyword">lambda</span>: stdout.readline(<span class="number">2048</span>), <span class="string">""</span>):</div><div class="line">            print(<span class="string">'[REMOTE-'</span> + name + <span class="string">'][INFO]'</span> + str(line), end=<span class="string">''</span>)</div><div class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> iter(<span class="keyword">lambda</span>: stderr.readline(<span class="number">2048</span>), <span class="string">""</span>):</div><div class="line">            print(<span class="string">'[REMOT-'</span> + name + <span class="string">'][ERROR]'</span> + str(line), end=<span class="string">''</span>)</div><div class="line">    print(<span class="string">'[INFO]'</span>+name+<span class="string">' install docker spark finish'</span>)</div><div class="line">    <span class="comment"># 使用Event保证Master部署完毕才启动Slave</span></div><div class="line">    <span class="keyword">if</span> event <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        event.wait()</div><div class="line">    stdin, stdout, stderr = ssh.exec_command(run_cmd)</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> iter(<span class="keyword">lambda</span>: stdout.readline(<span class="number">2048</span>), <span class="string">""</span>):</div><div class="line">        print(<span class="string">'[REMOTE-'</span> + name + <span class="string">'][INFO]'</span> + str(line), end=<span class="string">''</span>)</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> iter(<span class="keyword">lambda</span>: stderr.readline(<span class="number">2048</span>), <span class="string">""</span>):</div><div class="line">        print(<span class="string">'[REMOTE-'</span> + name + <span class="string">'][ERROR]'</span> + str(line), end=<span class="string">''</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_worker</span><span class="params">(current_worker, worker_index, master_addr, event)</span>:</span></div><div class="line">    docker_spark_start(current_worker[<span class="string">'IP'</span>], current_worker[<span class="string">'password'</span>], <span class="string">'WORKER-'</span>+str(worker_index),</div><div class="line">                       <span class="string">'docker run -d -p 8088:8088 -p 4040:4040 -p 7077:7077 -p 8080:8080 '</span></div><div class="line">                       <span class="string">'-p 6066:6066 --name=sparkWorker'</span> + str(worker_index) +</div><div class="line">                       <span class="string">' local/sparkcluster /app/start-slave.sh '</span> + master_addr,</div><div class="line">                       event)</div><div class="line"></div><div class="line"></div><div class="line">event = threading.Event()</div><div class="line">index = <span class="number">0</span></div><div class="line">worker_threads = []</div><div class="line"><span class="keyword">for</span> worker <span class="keyword">in</span> WORKERS:</div><div class="line">    t = threading.Thread(target=start_worker, name=<span class="string">'WORKER'</span>+str(index),</div><div class="line">                         args=(worker, index, MASTER[<span class="string">'innerIP'</span>]+<span class="string">':7077'</span>, event))</div><div class="line">    t.daemon = <span class="keyword">True</span></div><div class="line">    t.start()</div><div class="line">    worker_threads.append(t)</div><div class="line">    index += <span class="number">1</span></div><div class="line">docker_spark_start(MASTER[<span class="string">'IP'</span>], MASTER[<span class="string">'password'</span>], <span class="string">'MASTER'</span>,</div><div class="line">                   <span class="string">'docker run -d -p 8088:8088 -p 4040:4040 -p 7077:7077 -p 8080:8080 '</span></div><div class="line">                   <span class="string">'-p 6066:6066 --name=sparkMaster local/sparkcluster /app/start-master.sh'</span>)</div><div class="line"></div><div class="line">event.set()</div><div class="line">print(<span class="string">'[INFO]Deploy spark master finish'</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> t <span class="keyword">in</span> worker_threads:</div><div class="line">    t.join()</div><div class="line">os.remove(<span class="string">'config.json.tmp'</span>)</div><div class="line">print(<span class="string">'[INFO]Deploy spark workers finish'</span>)</div></pre></td></tr></table></figure>
<p>docker 安装脚本<code>docker_install.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment"># docker_install.sh for ubuntu16.04</span></div><div class="line">apt update</div><div class="line">apt install python3 -y</div><div class="line">apt install vim -y</div><div class="line">apt install apt-transport-https -y</div><div class="line">apt install ca-certificates -y</div><div class="line">apt install curl -y</div><div class="line">apt install software-properties-common -y</div><div class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</div><div class="line">apt-key fingerprint 0EBFCD88</div><div class="line">add-apt-repository <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></div><div class="line">apt update</div><div class="line">apt install docker-ce -y</div><div class="line">apt install python3 -y</div><div class="line">apt install python3-pip -y</div><div class="line">pip3 install --upgrade pip</div><div class="line">pip3 install oss2</div><div class="line">python3 get_docker_image.py</div><div class="line">rm config.json</div><div class="line">docker stop $(docker ps -a -q)</div><div class="line">docker rm $(docker ps -a -q)</div><div class="line">docker rmi $(docker images -q)</div><div class="line">docker load --input dockerImage.tar</div><div class="line">rm dockerImage.tar</div><div class="line">rm get_docker_image.py</div></pre></td></tr></table></figure>
<p>镜像获取<code>get_docker_image.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> oss2</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'config.json'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">    config_data = json.load(f)</div><div class="line">OSS_END_POINT = config_data[<span class="string">'end_point'</span>]</div><div class="line">OSS_BUCKET_NAME = config_data[<span class="string">'bucket_name'</span>]</div><div class="line">OSS_ACCESS_ID = config_data[<span class="string">'access_key_id'</span>]</div><div class="line">OSS_ACCESS_SECRET = config_data[<span class="string">'access_key_secret'</span>]</div><div class="line">OSS_DOCKER_IMAGE_NAME = config_data[<span class="string">'oss_docker_image_name'</span>]</div><div class="line"></div><div class="line">print(<span class="string">'start get docker image from oss'</span>)</div><div class="line">sys.stdout.flush()</div><div class="line">auth = oss2.Auth(OSS_ACCESS_ID, OSS_ACCESS_SECRET)</div><div class="line">bucket = oss2.Bucket(auth, OSS_END_POINT, OSS_BUCKET_NAME)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">percentage</span><span class="params">(consumed_bytes, total_bytes)</span>:</span></div><div class="line">    <span class="keyword">if</span> total_bytes:</div><div class="line">        rate = int(<span class="number">100</span> * (float(consumed_bytes) / float(total_bytes)))</div><div class="line">        <span class="keyword">if</span> percentage.last_rate != rate:</div><div class="line">            print(<span class="string">'&#123;0&#125;% -- &#123;1:.1f&#125;mb/&#123;2:.1f&#125;mb'</span>.format(rate, consumed_bytes/<span class="number">1024</span>/<span class="number">1024</span>, total_bytes/<span class="number">1024</span>/<span class="number">1024</span>))</div><div class="line">            sys.stdout.flush()</div><div class="line">            percentage.last_rate = rate</div><div class="line"></div><div class="line">percentage.last_rate = <span class="number">0</span></div><div class="line">bucket.get_object_to_file(OSS_DOCKER_IMAGE_NAME, <span class="string">'dockerImage.tar'</span>, progress_callback=percentage)</div></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>回头想想，似乎 docker 的使用也没有那么必要。只是装了一层皮，相对的部署环境会更加统一和无脑。唯一的麻烦就是为了保证最新版本，过段时间就要更新一下那个 spark 的 docker 镜像，同时 <code>docker_install.sh</code>脚本因为涉及到<code>apt install</code>命令，其实也需要常常查看有什么幺蛾子。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"># Docker</a>
          
            <a href="/tags/Spark/" rel="tag"># Spark</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/13/blog-rebuild/" rel="next" title="Hexo博客改造记">
                <i class="fa fa-chevron-left"></i> Hexo博客改造记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/12/linux-login/" rel="prev" title="服务器登录管理">
                服务器登录管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="zjuturtle" />
          <p class="site-author-name" itemprop="name">zjuturtle</p>
           
              <p class="site-description motion-element" itemprop="description">瞎几把搞的幸运E</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zjuturtle" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker"><span class="nav-number">1.</span> <span class="nav-text">Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spark"><span class="nav-number">2.</span> <span class="nav-text">Spark</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-网络"><span class="nav-number">3.</span> <span class="nav-text">Docker 网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署"><span class="nav-number">4.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zjuturtle</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("WPxUE6YkPBut4XJcmskHhlvL-gzGzoHsz", "oCVD6rCmlv3Nx4jcOX0UiWNW");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
